<template name="jobs">

  <h2 class="page-header">Jobs</h2>

  <p><a class="btn btn-default" href="{{pathFor 'jobs.add'}}" role="button">Add job</a></p>

  <table class="table table-condensed table-striped table-bordered">
    <thead>
      <tr>
        <th>Job</th>
        <th>Status</th>
        <th>Created at</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {{#each jobs}}
        {{>jobsTableItem}}
      {{/each}}
    </tbody>
  </table>

</template>

<template name="jobsTableItem">
  <tr class="{{jobIsRunningCssClass this}}">
    <th scope="row"><a href="{{pathFor 'jobs.edit'}}">{{name}}</a></th>
    <td>{{status}}</td>
    <td>{{createdAt}}</td>
    <td>
      {{#if jobIsRunning this}}
        <a href="#" class="job-status-switch" data-job-status="stopped">Stop</a>
      {{else}}
        <a href="#" class="job-status-switch" data-job-status="working">Start</a>
      {{/if}}
      - <a href="{{pathFor 'jobs.results.index'}}">See results</a>
    </td>
  </tr>
</template>

<template name="jobsAlertMessage">
  <div class="alert alert-warning" role="alert">
    Visit the help section to check how to return jobs results and other available methods. <a href="https://joseconstela.github.io/acio-js/help.html" class="alert-link">Visit the help section</a>
  </div>
</template>

<template name="jobsAdd">
  {{> jobsAlertMessage}}
  <h2 class="page-header">Add a new job</h2>
  {{> quickForm collection="Jobs" id="jobForm" type="insert"}}
</template>

<template name="jobsEdit">
  <h2 class="page-header">Update job</h2>

  {{#if equal job.status 'working'}}
    <div role="alert" class="alert alert-warning">
      Can not edit working jobs with <strong>working</strong> status.
      You first need to stop it.
      Note that changing jobs code may change and screw its results.
    </div>
  {{else}}
    {{> jobsAlertMessage}}
    {{> quickForm collection="Jobs" id="jobForm" type="update" doc=job}}
  {{/if}}

  <label class="control-label">History</label>
  <table class="table table-condensed table-striped table-bordered">
    <thead>
      <tr>
        <th>Status</th>
        <th>At</th>
      </tr>
    </thead>
    <tbody>
      {{#each job.history}}
      <tr>
        <td>{{status}} {{#if comment}}<br>{{comment}}{{/if}}</td>
        <td>{{at}}</td>
      </tr>
      {{/each}}
    </tbody>
  </table>

  <a href="{{pathFor 'jobs.results.index' data=job}}">See job's results</a>

</template>

<template name="jobsTop5Results">
  <h2 class="page-header">Top 5 job results</h2>

  <table class="table table-condensed table-striped table-bordered">
    <thead>
      <tr>
        <th>Result</th>
        <th>Result hash</th>
        <th>Count</th>
      </tr>
    </thead>
    <tbody>
      {{#each results}}
      {{> jobsResultTableItem}}
      {{/each}}
    </tbody>
  </table>

  {{> jobResultsLinks}}

</template>

<template name="jobResultsLinks">
  <a class="btn btn-primary {{#if currentRouteIs 'job.results.index'}}active{{/if}}" href="{{pathFor 'jobs.results.index' data=job}}">Top 5 job results</a>
  <a class="btn btn-primary {{#if currentRouteIs 'job.results.top'}}active{{/if}}" href="{{pathFor 'jobs.results.top' data=job}}">All top results</a>
  <a class="btn btn-primary {{#if currentRouteIs 'job.results.all'}}active{{/if}}" href="{{pathFor 'jobs.results.all' data=job}}">All results</a>
</template>

<template name="jobsAllTopResults">
  <h2 class="page-header">All top job results</h2>

  <table class="table table-condensed table-striped table-bordered">
    <thead>
      <tr>
        <th>Result</th>
        <th>Result hash</th>
        <th>Count</th>
      </tr>
    </thead>
    <tbody>
      {{#each results}}
      {{> jobsResultTableItem}}
      {{/each}}
    </tbody>
  </table>

  {{> jobResultsLinks}}
</template>

<template name="jobsResultsAll">
  <h2 class="page-header">All results</h2>

  <table class="table table-condensed table-striped table-bordered">
    <thead>
      <tr>
        <th>Result</th>
        <th>Hashed result</th>
        <th>At</th>
      </tr>
    </thead>
    <tbody>
      {{#each results}}
        {{> jobsResultAllTableItem}}
      {{/each}}
    </tbody>
  </table>

  {{> jobResultsLinks}}

</template>

<template name="jobsResultAllTableItem">
  <tr>
    <td><a href="{{pathFor 'jobs.result'}}">{{resultId}}</a></td>
    <td>{{hashedResult}}</td>
    <td>{{createdAt}}</td>
  </tr>
</template>

<template name="jobsResultTableItem">
  <tr>
    <td class="code">{{jsonPretty _r._id.data}}</td>
    <td>{{_r._id.hashedResult}}</td>
    <td>{{_r.count}}</td>
  </tr>
</template>

<template name="jobsResultsView">
  <h2 class="page-header">Result</h2>
  <pre>{{jsonPretty result.data}}</pre>
</template>
